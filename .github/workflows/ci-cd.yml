name: C++ CI/CD with Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test-linux:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        compiler: [g++, clang++]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential
    
    - name: Configure with CMake
      run: |
        mkdir build
        cd build
        cmake ..
    
    - name: Build project
      run: |
        cd build
        make -j4
    
    - name: Run unit tests
      run: |
        cd build
        ./test_ip_filter
    
    - name: Create artifact
      run: |
        mkdir -p artifacts/linux-${{ matrix.compiler }}
        cp build/ip_filter artifacts/linux-${{ matrix.compiler }}/ || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ip-filter-linux-${{ matrix.compiler }}
        path: artifacts/linux-${{ matrix.compiler }}
        retention-days: 7

  build-and-test-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1
    
    - name: Configure with CMake
      run: |
        mkdir build
        cd build
        cmake ..
    
    - name: Build project
      run: |
        cd build
        cmake --build . --config Release
    
    - name: Run unit tests
      run: |
        cd build/Release
        .\test_ip_filter.exe
    
    - name: Create artifact
      run: |
        mkdir -p artifacts/windows
        Copy-Item "build/Release/ip_filter.exe" "artifacts/windows/" -ErrorAction SilentlyContinue
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ip-filter-windows
        path: artifacts/windows
        retention-days: 7

  test-coverage:
    runs-on: ubuntu-latest
    needs: [build-and-test-linux, build-and-test-windows]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate test coverage report
      run: |
        echo "Test coverage report would be generated here"
        echo "All tests passed successfully!"
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          build/test_results/
        retention-days: 7
